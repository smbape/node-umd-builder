From c4fc3a1f5a0045c23046cc83ce634637d380164d Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?St=C3=A9phane=20MBAPE?= <rose.martin-8og3raxw@yopmail.com>
Date: Sun, 29 May 2016 11:27:45 +0200
Subject: [PATCH] fix ready event emitted before all files have been read

---
 lib/fs_utils/file_list.js | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/lib/fs_utils/file_list.js b/lib/fs_utils/file_list.js
index e70d6a7..ba3e7bd 100644
--- a/lib/fs_utils/file_list.js
+++ b/lib/fs_utils/file_list.js
@@ -48,6 +48,7 @@ class FileList extends EventEmitter {
     this.compiled = new Set();
     this.initial = true;
     this.disposed = false;
+    this.reading = 0;
 
     this.on('change', this._change);
     this.on('unlink', this._unlink);
@@ -92,7 +93,7 @@ class FileList extends EventEmitter {
   }
 
   hasPendingFiles() {
-    return this.compiling.size > 0 || this.copying.size > 0;
+    return this.reading > 0 || this.compiling.size > 0 || this.copying.size > 0;
   }
 
   resetTimer() {
@@ -224,7 +225,9 @@ class FileList extends EventEmitter {
       }
     } else {
       debug(`Reading ${path}`);
+      this.reading++;
       readFileAndCache(path, error => {
+        this.reading--;
         if (this.disposed) { return; }
         if (error) throw new Error(formatError('Reading', error));
         // .json files from node_modules should always be compiled

-- 
2.6.2.windows.1

